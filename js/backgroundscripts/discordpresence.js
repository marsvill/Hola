const PreventDuplicateScript_68=0;let DiscordToken,DiscordInfo,DiscordLoggedIn=!1,DiscordWS;async function GetDiscordToken(){return DiscordToken||(DiscordToken=await LocalStorage.get("DiscordToken"),DiscordToken)}async function CloseDiscord(){DiscordWS&&(await DiscordWS.close(1e3),DiscordWS=null)}async function GetPlaceInfo(e){const[n,s]=await RequestFunc(`https://games.roblox.com/v1/games/multiget-place-details?placeIds=${e}`,"GET",null,null,!0);return n?[!0,s[0]]:[!1]}async function GetUniverseInfo(e){const[n,s]=await RequestFunc(`https://games.roblox.com/v1/games?universeIds=${e}`,"GET",null,null,!0);return n?[!0,s.data[0]]:[!1]}async function GetUniverseThumbnail(e){const[n,s]=await RequestFunc(`https://thumbnails.roblox.com/v1/games/icons?universeIds=${e}&returnPolicy=PlaceHolder&size=512x512&format=Png&isCircular=false`,"GET",null,null,!0);return n&&s.data[0]?.imageUrl||"https://tr.rbxcdn.com/53eb9b17fe1432a809c73a13889b5006/512/512/Image/Png"}async function ImageUrlToExternalDiscord(e){const[n,s]=await RequestFunc("https://canary.discord.com/api/v9/applications/1105722413905346660/external-assets","POST",{"Content-Type":"application/json",Authorization:DiscordToken},JSON.stringify({urls:[e]}));return n?"mp:"+s[0].external_asset_path:"1105722509627772958"}function HasPermissionsForDiscord(){return new Promise(e=>{chrome.permissions.contains({origins:["https://www.discord.com/"]},function(n){e(n)})})}async function OpenDiscord(e){if(!await IsFeatureEnabled("DiscordPresence")||!await HasPermissionsForDiscord()||ExternalDiscordLoggedIn||!e&&(DiscordLoggedIn||!await GetDiscordToken()))return;const n=new WebSocket(e?.url||"wss://gateway.discord.gg/?v=10&encoding=json");DiscordWS=n;function s(a){typeof a=="object"?n.send(JSON.stringify(a)):n.send(a)}async function x(){s({op:2,d:{token:DiscordToken,properties:{os:"Windows",browser:"RoQoL"}}})}let o=0,u=0,d="",p=!1,r=0,b=await IsFeatureEnabled("DiscordPresenceJoin");async function y(){let a=await IsFeatureEnabled("DiscordPresenceJoin");if(LastPlaceId!=o||LastJobId!=d||LastPlaceId!=0&&a!=b){if(b=a,!LastInGame||LastPlaceId==0){d=LastJobId,o=LastPlaceId,u=LastUniverseId,p=LastInGame,s({op:3,d:{since:r,activities:[],status:"invisible",afk:!1}});return}const[t,i]=await GetUniverseInfo(LastUniverseId);if(!t)return;LastUniverseId!=u&&(r=Date.now()),d=LastJobId,o=LastPlaceId,u=LastUniverseId,p=LastInGame;const _=await ImageUrlToExternalDiscord(await GetUniverseThumbnail(u));let l=i.name;const G=i.creator.name,U=i.creator.hasVerifiedBadge;l.length<2&&(l=l+"(00(00(00");const v=["View Game"],P=[`https://www.roblox.com/games/${o}`];a&&(v.unshift("Join"),P.unshift(`roblox://experiences/start?placeId=${o}&gameInstanceId=${d}`)),s({op:3,d:{since:r,activities:[{name:"Roblox",type:0,instance:!0,created_at:r,application_id:"1105722413905346660",details:l,buttons:v,metadata:{button_urls:P},state:`by ${G}${U?" \u2611\uFE0F":""}`,assets:{large_text:l,large_image:_,small_image:"1105722508038115438",small_text:"Roblox"},timestamps:{start:r}}],status:"invisible",afk:!1}})}}let f,c,m,g,w=!1,L,D,h=!1;function I(){s({op:1,d:g})}function T(){h=!0,n.close(1e3)}n.onmessage=async function(a){const t=JSON.parse(a.data);if(t.op==0&&t.t=="READY"){D=t.d.resume_gateway_url,L=t.d.session_id;const i=t.d.user;DiscordInfo={Id:i.id,Avatar:i.avatar,Name:i.username,Discriminator:i.discriminator}}else t.op==9&&t.d==!1?T():t.op==10?c=setTimeout(function(){c&&(f=setInterval(I,t.d.heartbeat_interval),I())},t.d.heartbeat_interval*Math.random()):t.op==1?I():(t.op==7||t.op==9&&t.d==!0)&&(w=!0);t.s&&(g=t.s)},n.onopen=async function(){e&&s({op:6,d:{token:e.token,session_id:e.session_id,seq:e.seq}}),DiscordLoggedIn=!0,await x(),m=setInterval(y,5*1e3)};const S=[4e3,4001,4002,4003,4005,4007,4008,4009];n.onclose=async function(a){if(DiscordInfo=null,m&&(clearInterval(m),m=null),c&&(clearTimeout(c),c=null),f&&(clearInterval(f),f=null),!h&&(w||!a.code||S.includes(a.code))){await sleep(1e3),OpenDiscord({url:D,token:DiscordToken,session_id:L,seq:g});return}await sleep(1e3*10),DiscordLoggedIn=!1,OpenDiscord()}}BindToOnMessage("DiscordPresenceNewTab",!1,function(){chrome.runtime.openOptionsPage()}),BindToOnMessage("DiscordPresencePermitted",!0,function(){return HasPermissionsForDiscord()}),BindToOnMessage("NewDiscordToken",!1,function(e){e.token!=DiscordToken&&(DiscordToken=e.token,DiscordInfo=null,LocalStorage.set("DiscordToken",DiscordToken),CloseDiscord().then(async function(){await sleep(1e3*2),OpenDiscord()}))}),BindToOnMessage("GetDiscordInfo",!1,function(){if(DiscordInfo)return DiscordInfo;if(ExternalDiscordLoggedIn)return!1}),ListenForSettingChanged("DiscordPresence",function(e){!e&&!ExternalDiscordLoggedIn&&DiscordLoggedIn?CloseDiscord():e&&!ExternalDiscordLoggedIn&&!DiscordLoggedIn&&OpenDiscord()}),setTimeout(OpenDiscord,1e3);

//# sourceMappingURL=https://roqol.io/assets/sourcemap/chrome/2.33.1/js/backgroundscripts/discordpresence.js