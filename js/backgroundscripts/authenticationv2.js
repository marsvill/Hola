const PreventDuplicateScript_65=0;let LastAuthKeyAttempt=0,LastAuthenticatedUserId,FirstAuthenticationAttempt=!0,CurrentAuthenticationMethod="",FetchedAuthenticationFromStorage=!1,AuthenticationFailuresCounter=0,AuthenticationError="";async function HasGameFavourited(e){const[t,r]=await RequestFunc(`https://games.roblox.com/v1/games/${e}/favorites`,"GET",void 0,void 0,!0);return t?[!0,r.isFavorited]:[!1,!1]}function AlertTabsOfNewAuthKey(e){for(let t=0;t<ActiveRobloxPages.length;t++)chrome.tabs.sendMessage(ActiveRobloxPages[t],{type:"Reauthenticating",AuthKey:e})}async function ReauthenticateV2(){const e=await GetCurrentUserId();if(!e)return CachedAuthKey;const[t,r]=await RequestFunc(WebServerEndpoints.AuthenticationV2+"reverify","POST");return t&&(CachedAuthKey=r.Key,AlertTabsOfNewAuthKey(CachedAuthKey),LocalStorage.set("AuthKey",JSON.stringify({UserId:e,Key:CachedAuthKey}))),CachedAuthKey}async function GetAuthKey(){for(Date.now()/1e3-LastAuthKeyAttempt<3&&await sleep(3e3);FetchingAuthKey;)await sleep(100);FetchingAuthKey=!0;let e="";const t=await GetCurrentUserId();if(!t)return AuthenticationError="Wrapper: Not logged in",FetchingAuthKey=!1,"";if(e=await GetOAuthKey(t),e==""&&(e=await GetAuthKeyV2(t)),e==""?AuthenticationFailuresCounter++:AuthenticationFailuresCounter=0,FetchingAuthKey=!1,AuthenticationFailuresCounter>5)for(let r=0;r<ActiveRobloxPages.length;r++)chrome.tabs.sendMessage(ActiveRobloxPages[r],{type:"AuthenticationFailure",Failed:!0});return e}async function WaitForGameFavourite(e,t,r=!0,a=15){const i=Date.now()/1e3+a;for(;i>Date.now()/1e3;){if(await GetCurrentUserId()!==e)return!1;const[u,f]=await RequestFunc(`https://www.roblox.com/users/favorites/list-json?assetTypeId=9&itemsPerPage=1&pageNumber=1&userId=${e}`,"GET",void 0,void 0,!0);if(u){const o=f?.Data?.Items?.[0]?.Item?.UniverseId;if(r&&t==o||!r&&t!=o)return!0}await sleep(2e3)}return!1}async function GetAuthKeyV2(e){async function t(){return e===await GetCurrentUserId()}if(CachedAuthKey!=""&&e==LastAuthenticatedUserId)return CachedAuthKey;if(e!=LastAuthenticatedUserId&&!FirstAuthenticationAttempt&&(CachedAuthKey="",AlertTabsOfNewAuthKey(),await LocalStorage.remove("AuthKey")),FirstAuthenticationAttempt=!1,LastAuthKeyAttempt=Date.now()/1e3,StoredKey=await LocalStorage.get("AuthKey"),StoredKey)try{StoredKey=JSON.parse(StoredKey)}catch{}if(StoredKey&&(typeof StoredKey=="string"&&(StoredKey={UserId:e,Key:StoredKey},await LocalStorage.set("AuthKey",JSON.stringify(StoredKey))),StoredKey.UserId==e))return FetchedAuthenticationFromStorage=!0,CachedAuthKey=StoredKey.Key,LastAuthenticatedUserId=e,CachedAuthKey;if(FetchedAuthenticationFromStorage=!1,!await t())return"";CurrentAuthenticationMethod="Favourite",LastAuthenticatedUserId=e;const[r,a,i]=await RequestFunc(WebServerEndpoints.AuthenticationV2+"fetch","POST",void 0,JSON.stringify({UserId:e}));if(!r||!await t())return AuthenticationError=`Favourite: Starting verification failed or account changed (${JSON.stringify(a)} ${i?.status})`,"";if(Key=a.Key,UniverseId=a.UniverseId,ForceMustUnfavourite=!1,!a.MustUnfavourite){if([Success,Favourited,Result]=await HasGameFavourited(UniverseId),!Success)return AuthenticationError=`Favourite: Failed to check if favourited (${JSON.stringify(Favourited)} ${Result?.status})`,"";ForceMustUnfavourite=Favourited}if(!await t())return;if(a.MustUnfavourite||ForceMustUnfavourite){const[n,s,h]=await SetFavouriteGame(UniverseId,!1);if(!n)return AuthenticationError=`Favourite: Failed to unfavourite game for clear (${JSON.stringify(s)} ${h?.status})`,"";if(a.MustUnfavourite){await WaitForGameFavourite(e,UniverseId,!1,15);const[c,y,S]=await RequestFunc(WebServerEndpoints.AuthenticationV2+"clear","POST",void 0,JSON.stringify({Key}));if(!c)return AuthenticationError=`Favourite: Failed to send clear verification (${JSON.stringify(y)} ${S?.status})`,""}}const[u,f,o]=await SetFavouriteGame(UniverseId,!0);if(!u||!await t())return AuthenticationError=`Favourite: Failed to favourite verification game or account changed (${JSON.stringify(f)} ${o?.status})`,"";if(await WaitForGameFavourite(e,UniverseId,!0,15),!await t())return;const[l,d]=await RequestFunc(WebServerEndpoints.AuthenticationV2+"verify","POST",void 0,JSON.stringify({Key}));if(await t())return l&&(CachedAuthKey=d.Key,LocalStorage.set("AuthKey",JSON.stringify({UserId:e,Key:CachedAuthKey})),AlertTabsOfNewAuthKey(CachedAuthKey)),new Promise(async function(){let n=0;for(;;){if(!await t())return;const[s]=await SetFavouriteGame(UniverseId,!1);if(s)break;n++,n>10&&(n=10),await sleep(1e3*(10+n))}}),AuthenticationFailuresCounter=0,CachedAuthKey}async function GetAuthKeyDetailed(){const e=await GetAuthKey();return[e!=""?e:null,e!=""?LastAuthenticatedUserId:null]}function IsOver13(e,t,r){const a=new Date,i=new Date(e,t,r);return a.getUTCFullYear()-i.getUTCFullYear()>13||a.getUTCMonth()>i.getUTCMonth()||a.getUTCDay()>=i.getUTCDay()}async function GetOAuthKey(e){async function t(){return e===await GetCurrentUserId()}if(CachedAuthKey!=""&&e==LastAuthenticatedUserId)return CachedAuthKey;if(e!=LastAuthenticatedUserId&&!FirstAuthenticationAttempt&&(CachedAuthKey="",AlertTabsOfNewAuthKey(),await LocalStorage.remove("AuthKey")),FirstAuthenticationAttempt=!1,LastAuthKeyAttempt=Date.now()/1e3,StoredKey=await LocalStorage.get("AuthKey"),StoredKey)try{StoredKey=JSON.parse(StoredKey)}catch{}if(StoredKey&&(typeof StoredKey=="string"&&(StoredKey={UserId:e,Key:StoredKey},await LocalStorage.set("AuthKey",JSON.stringify(StoredKey))),StoredKey.UserId==e))return FetchedAuthenticationFromStorage=!0,CachedAuthKey=StoredKey.Key,LastAuthenticatedUserId=e,CachedAuthKey;if(CurrentAuthenticationMethod="OAuth",FetchedAuthenticationFromStorage=!1,!await t())return"";LastAuthenticatedUserId=e;let[r,a,i]=await RequestFunc("https://accountinformation.roblox.com/v1/birthdate","GET",void 0,void 0,!0);if(r&&!IsOver13(a.birthYear,a.birthMonth,a.birthDay))return AuthenticationError=`OAuth: Not over 13 (${JSON.stringify(a)} ${i?.status})`,"";if([r,_,i]=await RequestFunc(`${WebServerEndpoints.OAuth}?userId=${e}`,"GET",void 0,void 0,!0,!0),!r)return AuthenticationError=`OAuth: Failed to start (${i?.status})`,"";if(!await t())return"";const u=new URLSearchParams(i.url.split("?")[1]),f=[],o=u.get("scope").split(" ");for(let n=0;n<o.length;n++){let s=o[n],h=["read"];const c=s.split(":");c.length>2?s=c[0]:c.length==2&&(s=c[0],h=[c[1]]),f[n]={scopeType:s,operations:h}}function l(n){return n.charAt(0).toUpperCase()+n.slice(1)}const d={clientId:u.get("client_id"),codeChallenge:u.get("code_challenge"),codeChallengeMethod:u.get("code_challenge_method"),nonce:u.get("nonce"),redirectUri:u.get("redirect_uri"),resourceInfos:[{owner:{id:e.toString(),type:"User"},resources:{}}],responseTypes:[l(u.get("response_type"))],scopes:f,state:u.get("state")};return[r,a,i]=await RequestFunc("https://apis.roblox.com/oauth/v1/authorizations","POST",{"Content-Type":"application/json"},JSON.stringify(d),!0,!1),r?a?.location?([r,a,i]=await RequestFunc(a.location,"GET",{type:"Authentication"},void 0,!1,!0),r?(CachedAuthKey=(await i.json()).Key,LocalStorage.set("AuthKey",JSON.stringify({UserId:e,Key:CachedAuthKey})),AlertTabsOfNewAuthKey(CachedAuthKey),AuthenticationFailuresCounter=0,CachedAuthKey):(AuthenticationError=`OAuth: Callback failed (${JSON.stringify(a)} ${i?.status})`,"")):(AuthenticationError="OAuth: Location missing",""):(a?.code==="UnauthorizedAccess"&&!await IsFeatureKilled("UnauthorizedWrongUserIdFix")&&(AuthenticationError=`OAuth: Roblox accept authentication failed (${JSON.stringify(a)} ${i?.status})`,e=null,GetCurrentUserId()),"")}

//# sourceMappingURL=https://roqol.io/assets/sourcemap/chrome/2.33.1/js/backgroundscripts/authenticationv2.js